<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport"
content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<title>Инвентаризация</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #0f0f0f;
    color: white;
}

.container {
    padding: 14px;
}

.group {
    background: #1b1b1b;
    border-radius: 14px;
    margin-bottom: 12px;
    overflow: hidden;
}

.group-header {
    padding: 14px;
    font-weight: bold;
    background: #202020;
    display: flex;
    justify-content: space-between;
    cursor: pointer;
}

.items {
    display: none;
    padding: 10px;
}

.item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.item-name {
    flex: 1;
    font-size: 14px;
}

.calc {
    display: flex;
    gap: 6px;
    align-items: center;
}

.calc input {
    width: 55px;
    background: #2b2b2b;
    border: none;
    color: white;
    text-align: center;
    border-radius: 6px;
    padding: 6px;
}

.plus {
    width: 30px;
    height: 30px;
    background: #2b2b2b;
    border: none;
    color: white;
    border-radius: 8px;
    font-size: 18px;
}

.footer {
    position: sticky;
    bottom: 0;
    display: flex;
    gap: 10px;
    margin-top: 20px;
}

.save {
    flex: 1;
    padding: 14px;
    background: #2e8b57;
    border: none;
    border-radius: 12px;
    color: white;
}

.clear {
    flex: 1;
    padding: 14px;
    background: #8b2e2e;
    border: none;
    border-radius: 12px;
    color: white;
}
</style>
</head>

<body>
<div class="container">
<h2 id="title"></h2>
<div id="groups"></div>

<div class="footer">
<button class="save" onclick="saveInventory()">💾 Сохранить</button>
<button class="clear" onclick="clearAll()">🗑 Очистить</button>
</div>
</div>

<script>
let tg = null;

if (window.Telegram && Telegram.WebApp) {
    tg = Telegram.WebApp;
    tg.ready();
    tg.expand();
    tg.disableVerticalSwipes();
}

const params = new URLSearchParams(window.location.search);
const section = params.get("section") || "shop";

document.getElementById("title").textContent =
    section.charAt(0).toUpperCase() + section.slice(1);

async function loadData() {
    const res = await fetch(`/data/${section}.json`);
    const data = await res.json();
    render(data);
}

function render(data) {

    const container = document.getElementById("groups");
    container.innerHTML = "";

    data.forEach(group => {

        const g = document.createElement("div");
        g.className = "group";

        const header = document.createElement("div");
        header.className = "group-header";
        header.innerHTML = `<span>${group.group}</span><span>▼</span>`;

        const items = document.createElement("div");
        items.className = "items";

        header.onclick = () => {
            items.style.display =
                items.style.display === "block" ? "none" : "block";
        };

        group.items.forEach(item => {

            const row = document.createElement("div");
            row.className = "item";

            const name = document.createElement("div");
            name.className = "item-name";
            name.textContent = item.name;

            const calc = document.createElement("div");
            calc.className = "calc";

            const input = document.createElement("input");
            input.type = "number";
            input.min = "0";

            const plus = document.createElement("button");
            plus.className = "plus";
            plus.textContent = "+";

            const total = document.createElement("input");
            total.type = "number";
            total.value = "0";
            total.dataset.article = item.article;
            total.dataset.group = group.group;

            plus.onclick = () => {
                total.value =
                    parseFloat(total.value || 0) +
                    parseFloat(input.value || 0);
                input.value = "";
            };

            calc.appendChild(input);
            calc.appendChild(plus);
            calc.appendChild(total);

            row.appendChild(name);
            row.appendChild(calc);

            items.appendChild(row);
        });

        g.appendChild(header);
        g.appendChild(items);
        container.appendChild(g);
    });
}

function clearAll() {
    document.querySelectorAll(".calc input[type='number']:last-child")
        .forEach(i => i.value = "0");
}

async function saveInventory() {

    const filename = prompt("Введите название инвентаризации:");

    if (!filename) return;

    const totals = document.querySelectorAll(".calc input[type='number']:last-child");

    const items = [];

    totals.forEach(t => {
        if (parseFloat(t.value) > 0) {
            items.push({
                article: t.dataset.article,
                group: t.dataset.group,
                qty: parseFloat(t.value)
            });
        }
    });

    if (!items.length) {
        alert("Нет данных");
        return;
    }

    const res = await fetch("/save_inventory", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            user_id: tg?.initDataUnsafe?.user?.id || 0,
            filename: filename,
            items: items
        })
    });

    const data = await res.json();
    alert("Сохранено: " + data.count);
    clearAll();
}

loadData();
</script>
</body>
</html>
